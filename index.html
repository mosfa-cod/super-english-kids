<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø§Ù„ Ø¯Ø­Ø±ÙˆØ¬ | AI Assistant</title>
<style>
:root {
  --bg: #03000f;
  --primary: #7c3aff;
  --accent: #00f5ff;
  --accent2: #ff00c8;
  --text: #e8e0ff;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}

.setup-box {
  max-width: 500px;
  margin: 100px auto;
  background: rgba(12,6,45,0.95);
  border: 2px solid var(--primary);
  border-radius: 20px;
  padding: 2rem;
  text-align: center;
}
.setup-box h1 {
  background: linear-gradient(90deg, var(--accent), var(--primary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 1.5rem;
}
.setup-box input {
  width: 100%;
  padding: 1rem;
  background: rgba(0,0,0,0.3);
  border: 2px solid rgba(124,58,255,0.3);
  border-radius: 10px;
  color: #fff;
  font-size: 1rem;
  margin-bottom: 1rem;
}
.btn {
  width: 100%;
  padding: 1rem;
  background: linear-gradient(135deg, var(--primary), #4f46e5);
  border: none;
  border-radius: 10px;
  color: #fff;
  font-size: 1.1rem;
  font-weight: bold;
  cursor: pointer;
}

.chat-container {
  max-width: 900px;
  margin: 20px auto;
  height: 90vh;
  display: flex;
  flex-direction: column;
  background: rgba(12,6,45,0.95);
  border-radius: 20px;
  overflow: hidden;
}
.chat-header {
  background: linear-gradient(135deg, var(--primary), #4f46e5);
  padding: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.header-actions {
  display: flex;
  gap: 0.5rem;
}
.header-btn {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  color: #fff;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9rem;
}
.header-btn.new-chat {
  background: rgba(57,255,20,0.2);
  border-color: #39ff14;
  color: #39ff14;
}

.chat-messages {
  flex: 1;
  padding: 1rem;
  overflow-y: auto;
}
.message {
  margin-bottom: 1rem;
  padding: 1rem;
  border-radius: 15px;
  max-width: 80%;
}
.message.user {
  background: linear-gradient(135deg, var(--primary), #4f46e5);
  margin-left: auto;
  text-align: left;
}
.message.ai {
  background: rgba(124,58,255,0.1);
  border: 1px solid rgba(124,58,255,0.3);
  margin-right: auto;
}

.welcome-box {
  text-align: center;
  padding: 2rem;
  border: 2px dashed rgba(124,58,255,0.3);
  border-radius: 15px;
  margin-bottom: 1rem;
}
.welcome-box h2 {
  color: var(--accent);
  margin-bottom: 1rem;
}
.quick-actions {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 1rem;
}
.quick-btn {
  background: rgba(124,58,255,0.2);
  border: 1px solid var(--primary);
  color: var(--text);
  padding: 0.6rem 1.2rem;
  border-radius: 20px;
  cursor: pointer;
  font-size: 0.9rem;
}
.quick-btn:hover {
  background: var(--primary);
  color: #fff;
}

.voice-controls {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.5rem 1rem;
  background: rgba(0,0,0,0.2);
}
.speak-toggle {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: rgba(57,255,20,0.1);
  border: 1px solid #39ff14;
  color: #39ff14;
  border-radius: 20px;
  cursor: pointer;
  font-size: 0.9rem;
}
.speak-toggle.muted {
  background: rgba(255,0,0,0.1);
  border-color: #ff4444;
  color: #ff4444;
}

.voice-wave {
  display: none;
  align-items: center;
  justify-content: center;
  gap: 3px;
  height: 40px;
  padding: 0 1rem;
}
.voice-wave.active {
  display: flex;
}
.wave-bar {
  width: 4px;
  background: linear-gradient(180deg, var(--accent), var(--accent2));
  border-radius: 2px;
  animation: wave 0.8s ease-in-out infinite;
}
.wave-bar:nth-child(1) { height: 10px; animation-delay: 0s; }
.wave-bar:nth-child(2) { height: 20px; animation-delay: 0.1s; }
.wave-bar:nth-child(3) { height: 30px; animation-delay: 0.2s; }
.wave-bar:nth-child(4) { height: 25px; animation-delay: 0.15s; }
.wave-bar:nth-child(5) { height: 15px; animation-delay: 0.05s; }

@keyframes wave {
  0%, 100% { transform: scaleY(0.5); opacity: 0.5; }
  50% { transform: scaleY(1); opacity: 1; }
}

.chat-input-area {
  display: flex;
  gap: 0.5rem;
  padding: 1rem;
  background: rgba(0,0,0,0.3);
  align-items: center;
}
.chat-input {
  flex: 1;
  padding: 1rem;
  background: rgba(0,0,0,0.3);
  border: 2px solid rgba(124,58,255,0.3);
  border-radius: 10px;
  color: #fff;
  font-size: 1rem;
}
.voice-btn {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(135deg, var(--accent2), #9b00ff);
  color: #fff;
  font-size: 1.5rem;
  cursor: pointer;
}
.voice-btn.recording {
  animation: pulse 1s infinite;
  background: #ff0050;
}
@keyframes pulse {
  0%, 100% { box-shadow: 0 0 20px rgba(255,0,80,0.5); }
  50% { box-shadow: 0 0 40px rgba(255,0,80,0.9); }
}
.send-btn {
  padding: 1rem 2rem;
  background: var(--accent);
  color: #000;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: bold;
}

.speaker-icon {
  cursor: pointer;
  margin-left: 0.5rem;
  opacity: 0.7;
}
.speaker-icon:hover {
  opacity: 1;
}

.hidden { display: none !important; }
</style>
</head>
<body>

<div id="setupPage" class="setup-box">
  <h1>ğŸ” Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Groq</h1>
  <input type="password" id="apiKey" placeholder="gsk_...">
  <button class="btn" onclick="connect()">ğŸš€ Ø§ØªØµÙ„ ÙˆØ§Ø¨Ø¯Ø£</button>
</div>

<div id="chatPage" class="chat-container hidden">
  <div class="chat-header">
    <div>
      <div style="font-weight: bold;">ğŸ¤– Ù…Ø³Ø§Ø¹Ø¯ Ù…ØµØ·ÙÙ‰ Ø§Ù„Ø°ÙƒÙŠ</div>
      <small style="color: #00ff88;">â— Ù…ØªØµÙ„</small>
    </div>
    <div class="header-actions">
      <button class="header-btn new-chat" onclick="newChat()">ğŸ†• Ø¬Ø¯ÙŠØ¯</button>
      <button class="header-btn" onclick="disconnect()">ğŸ”Œ Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
  
  <div class="voice-controls">
    <button class="speak-toggle" id="speakToggle" onclick="toggleSpeak()">
      ğŸ”Š Ø§Ù„ØµÙˆØª: Ù…ÙØ¹Ù„
    </button>
    <span style="color: var(--text2); font-size: 0.85rem;">
      (Ø§Ø¶ØºØ· ğŸ”Š Ø¨Ø¬Ø§Ù†Ø¨ Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø§Ø³ØªÙ…Ø§Ø¹)
    </span>
  </div>
  
  <div class="chat-messages" id="messages"></div>
  
  <div class="voice-wave" id="voiceWave">
    <div class="wave-bar"></div>
    <div class="wave-bar"></div>
    <div class="wave-bar"></div>
    <div class="wave-bar"></div>
    <div class="wave-bar"></div>
    <span style="color: var(--accent); margin-right: 1rem; font-weight: bold;">ğŸ™ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...</span>
  </div>
  
  <div class="chat-input-area">
    <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">ğŸ™ï¸</button>
    <input type="text" class="chat-input" id="userInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." onkeypress="if(event.key==='Enter') send()">
    <button class="send-btn" onclick="send()">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<script>
let API_KEY = '';
let recognition = null;
let isRecording = false;
let speechSynthesis = window.speechSynthesis;
let speakEnabled = true;
let availableVoices = [];
let conversation = [];

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª
function loadVoices() {
  availableVoices = speechSynthesis.getVoices();
}

if (speechSynthesis) {
  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;
}

function toggleSpeak() {
  speakEnabled = !speakEnabled;
  const btn = document.getElementById('speakToggle');
  btn.innerHTML = speakEnabled ? 'ğŸ”Š Ø§Ù„ØµÙˆØª: Ù…ÙØ¹Ù„' : 'ğŸ”‡ Ø§Ù„ØµÙˆØª: Ù…Ø¹Ø·Ù„';
  btn.className = speakEnabled ? 'speak-toggle' : 'speak-toggle muted';
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙˆØª Ø¹Ø±Ø¨ÙŠ Ø£Ù†Ø«ÙˆÙŠ
function getArabicVoice() {
  const arabicVoices = availableVoices.filter(v => v.lang.includes('ar'));
  
  // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙˆØª Ø£Ù†Ø«ÙˆÙŠ
  let voice = arabicVoices.find(v => 
    v.name.includes('Female') || 
    v.name.includes('Laila') || 
    v.name.includes('Hoda') ||
    v.name.includes('Salma')
  );
  
  // Ø£ÙŠ ØµÙˆØª Ø¹Ø±Ø¨ÙŠ
  if (!voice && arabicVoices.length > 0) {
    voice = arabicVoices[0];
  }
  
  return voice;
}

// Ø§Ù„Ù†Ø·Ù‚ Ø¨Ø§Ù„ØµÙˆØª
function speak(text) {
  if (!speechSynthesis || !speakEnabled) return;
  
  // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø³Ø§Ø¨Ù‚
  speechSynthesis.cancel();
  
  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ
  const cleanText = text
    .replace(/<[^>]*>/g, '')
    .replace(/[^\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF\w\s.,!?]/gu, '')
    .trim()
    .substring(0, 250);
  
  if (!cleanText) return;
  
  const utterance = new SpeechSynthesisUtterance(cleanText);
  const voice = getArabicVoice();
  
  if (voice) {
    utterance.voice = voice;
    utterance.lang = voice.lang;
  } else {
    utterance.lang = 'ar-SA';
  }
  
  utterance.rate = 0.9;
  utterance.pitch = 1.1;
  utterance.volume = 1;
  
  speechSynthesis.speak(utterance);
}

// Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø©
function addMessage(role, text, withSpeak = false) {
  const div = document.createElement('div');
  div.className = 'message ' + role;
  
  if (role === 'ai') {
    const msgId = 'msg-' + Date.now();
    div.innerHTML = `<span class="speaker-icon" onclick="speakById('${msgId}')">ğŸ”Š</span><span id="${msgId}">${text}</span>`;
    
    if (withSpeak && speakEnabled) {
      setTimeout(() => speak(text), 200);
    }
  } else {
    div.innerHTML = text;
  }
  
  document.getElementById('messages').appendChild(div);
  div.scrollIntoView({ behavior: 'smooth' });
}

// Ù†Ø·Ù‚ Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ø¯Ø¯Ø©
function speakById(id) {
  const el = document.getElementById(id);
  if (el) speak(el.innerText);
}

// Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©
function newChat() {
  conversation = [];
  document.getElementById('messages').innerHTML = '';
  speechSynthesis.cancel();
  showWelcome();
}

// Ø¹Ø±Ø¶ Ø§Ù„ØªØ±Ø­ÙŠØ¨
function showWelcome() {
  const welcome = document.createElement('div');
  welcome.className = 'welcome-box';
  welcome.innerHTML = `
    <h2>ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙŠØ§ Ù…ØµØ·ÙÙ‰!</h2>
    <p>Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©. Ù‡Ø¬Ø§ÙˆØ¨ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„ØªÙƒ Ø¨Ø§Ø®ØªØµØ§Ø±.</p>
    <div class="quick-actions">
      <button class="quick-btn" onclick="setInput('Ø§Ø´Ø±Ø­ Ù„ÙŠ')">ğŸ“š Ø§Ø´Ø±Ø­</button>
      <button class="quick-btn" onclick="setInput('ØªØ±Ø¬Ù… Ù„ÙŠ')">ğŸŒ ØªØ±Ø¬Ù…</button>
      <button class="quick-btn" onclick="setInput('Ø³Ø§Ø¹Ø¯Ù†ÙŠ ÙÙŠ ÙƒÙˆØ¯')">ğŸ’» Ø¨Ø±Ù…Ø¬Ø©</button>
      <button class="quick-btn" onclick="setInput('Ø­Ù„ Ù…Ø³Ø£Ù„Ø©')">ğŸ§® Ø±ÙŠØ§Ø¶ÙŠØ§Øª</button>
    </div>
  `;
  document.getElementById('messages').appendChild(welcome);
}

function setInput(text) {
  document.getElementById('userInput').value = text;
  document.getElementById('userInput').focus();
}

// Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØµÙˆØª
function toggleVoice() {
  if (!('webkitSpeechRecognition' in window)) {
    alert('âŒ Ø¬Ø±Ø¨ Chrome');
    return;
  }
  
  if (isRecording) {
    stopRecording();
  } else {
    startRecording();
  }
}

function startRecording() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  
  recognition.lang = 'ar-SA';
  recognition.interimResults = true;
  recognition.continuous = false;
  
  recognition.onstart = () => {
    isRecording = true;
    document.getElementById('voiceBtn').classList.add('recording');
    document.getElementById('voiceBtn').innerHTML = 'â¹ï¸';
    document.getElementById('voiceWave').classList.add('active');
    speechSynthesis.cancel();
  };
  
  recognition.onresult = (event) => {
    const text = Array.from(event.results)
      .map(r => r[0].transcript)
      .join('');
    document.getElementById('userInput').value = text;
  };
  
  recognition.onend = () => {
    stopRecording();
    const text = document.getElementById('userInput').value.trim();
    if (text) send();
  };
  
  recognition.start();
}

function stopRecording() {
  if (recognition) try { recognition.stop(); } catch(e) {}
  isRecording = false;
  document.getElementById('voiceBtn').classList.remove('recording');
  document.getElementById('voiceBtn').innerHTML = 'ğŸ™ï¸';
  document.getElementById('voiceWave').classList.remove('active');
}

// Ø§Ù„Ø§ØªØµØ§Ù„
function connect() {
  const key = document.getElementById('apiKey').value.trim();
  if (!key.startsWith('gsk_')) {
    alert('âŒ Ø§Ù„Ù…ÙØªØ§Ø­ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ gsk_');
    return;
  }
  
  API_KEY = key;
  localStorage.setItem('groq_key', key);
  
  document.getElementById('setupPage').classList.add('hidden');
  document.getElementById('chatPage').classList.remove('hidden');
  
  showWelcome();
  
  // ØªØ±Ø­ÙŠØ¨ ØµÙˆØªÙŠ
  setTimeout(() => {
    speak('Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙŠØ§ Ù…ØµØ·ÙÙ‰! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø­Ø§Ø¬Ø©.');
  }, 500);
}

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
async function send() {
  const input = document.getElementById('userInput');
  const text = input.value.trim();
  if (!text) return;
  
  addMessage('user', text);
  input.value = '';
  
  // Ø¥Ø¸Ù‡Ø§Ø± "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±"
  const loading = document.createElement('div');
  loading.className = 'message ai';
  loading.id = 'loading';
  loading.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...';
  document.getElementById('messages').appendChild(loading);
  
  try {
    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${API_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'llama-3.1-8b-instant',
        messages: [
          {
            role: 'system',
            content: 'Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…ØµØ±ÙŠØ© ÙˆØ¯ÙˆØ¯Ø©. Ù‚ÙˆØ§Ø¹Ø¯Ùƒ: 1) Ø§Ø¬Ø¨ Ø¨Ø¬Ù…Ù„Ø© Ø£Ùˆ Ø¬Ù…Ù„ØªÙŠÙ† ÙÙ‚Ø· 2) Ù„Ø§ ØªØ·Ù„Ø¨ ØªÙˆØ¶ÙŠØ­Ø§Øª ÙƒØ«ÙŠØ±Ø© 3) Ù„Ùˆ Ø·Ù„Ø¨ ØªØ±Ø¬Ù…Ø©ØŒ ØªØ±Ø¬Ù… ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ø£Ø³Ø¦Ù„Ø© Ø¥Ø¶Ø§ÙÙŠØ© 4) ØªØ¬Ù†Ø¨ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø·ÙÙ„Ø¨Øª'
          },
          ...conversation.slice(-4),
          { role: 'user', content: text }
        ],
        max_tokens: 100,
        temperature: 0.7
      })
    });
    
    document.getElementById('loading').remove();
    
    const data = await response.json();
    
    if (data.error) {
      addMessage('ai', 'âŒ Ø®Ø·Ø£: ' + data.error.message);
    } else {
      const reply = data.choices[0].message.content;
      
      // Ø§Ø®ØªØµØ§Ø± Ø¥Ø°Ø§ Ø·ÙˆÙŠÙ„
      let shortReply = reply;
      if (reply.length > 150) {
        shortReply = reply.substring(0, 150) + '...';
      }
      
      addMessage('ai', shortReply, true);
      
      // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
      conversation.push(
        { role: 'user', content: text },
        { role: 'assistant', content: shortReply }
      );
    }
    
  } catch (err) {
    document.getElementById('loading').remove();
    addMessage('ai', 'âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„. Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
  }
}

function disconnect() {
  localStorage.removeItem('groq_key');
  location.reload();
}

// ØªØ­Ù…ÙŠÙ„
window.onload = () => {
  const saved = localStorage.getItem('groq_key');
  if (saved) {
    API_KEY = saved;
    document.getElementById('setupPage').classList.add('hidden');
    document.getElementById('chatPage').classList.remove('hidden');
    showWelcome();
    loadVoices();
  }
};
</script>

</body>
</html>